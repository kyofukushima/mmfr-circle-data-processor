# 育児サークル情報処理ツール - 詳細仕様書

## 1. アプリケーション概要

### 1.1 目的
- 育児サークル情報の効率的な管理・検証・インポート処理
- WordPressサイトへの正確なデータ投入支援
- データ品質の向上と作業効率化

### 1.2 技術スタック
- **フレームワーク**: Streamlit 1.28.0以上
- **データ処理**: pandas 2.0.0以上, openpyxl 3.1.0以上
- **エンコーディング**: chardet 5.0.0以上（UTF-8, Shift-JIS, CP932, EUC-JP対応）
- **非同期処理**: aiohttp 3.8.0以上（URL検証用）
- **AI機能**: OpenAI 1.0.0以上（gpt-4.1-mini-2025-04-14使用）

### 1.3 ファイル構成
- `app.py`: メインアプリケーション（3600行超）
- `validate.py`: URL検証専用モジュール
- `template.xlsx`: Excel出力テンプレート
- `.streamlit/config.toml`: Streamlit設定
- `.streamlit/secrets.toml`: API秘密鍵管理
- `requirements.txt`: Python依存関係
- `app_specification.md`: 本仕様書

## 2. 機能詳細

### 2.1 データ修正用エクセル作成機能

#### 2.1.1 処理フロー
1. **CSVファイル検証** (`validate_csv_file`)
   - エンコーディング自動検出（UTF-8→Shift-JIS→CP932→EUC-JP）
   - 必須列の存在確認
   - データ型検証

2. **施設情報検証** (`validate_facility_csv_file`)
   - **入力データ**: 施設情報CSVファイル
   - **必須列チェック**: `['施設名', '場所']`の存在確認
   - **施設名重複チェック**:
     - NaN値を空文字列に変換してから処理
     - `facility_data_str['施設名_str'].duplicated(keep=False)`で重複検出
     - `value_counts()`で重複回数を計算
     - 2回以上出現する施設名を抽出
     - 重複行の詳細情報（CSV行番号、場所）を表示
   - **空欄行検出**:
     - `facility_data['施設名'].isna() | (facility_data['施設名'] == '')`で空欄行を検出
     - 重複チェックで既に検出されている場合はスキップ
     - 空欄行の詳細情報（CSV行番号、場所）を表示
   - **エラー処理**: 重複または空欄が検出された場合は`ValueError`を発生

3. **先月データ整合性チェック** (`check_data_consistency`)
   - **入力データ**: 育児サークルCSVデータ、先月分Excelデータ
   - **必須列チェック**: `['スラッグ', 'サークル名']`の存在確認
   - **スラッグ重複チェック**:
     - `circle_data['スラッグ'].duplicated()`で各データ内の重複検出
     - 重複スラッグの詳細情報（行番号、サークル名）を表示
   - **スラッグ存在チェック**:
     - 空欄・欠損値を除外: `dropna().astype(str)`で処理
     - `['nan', 'None', '<NA>']`を除外してセット作成
     - 育児サークルデータのみ存在: `circle_slugs - last_month_slugs`
     - 先月分データのみ存在: `last_month_slugs - circle_slugs`
     - 不一致スラッグの詳細情報（スラッグ、サークル名）を表示
   - **エラー処理**: 重複または不一致が検出された場合は`st.error()`とともに`st.stop()`で処理停止

4. **Excelファイル生成** (`process_files`)
   - テンプレート適用
   - 条件付き書式設定
   - 列の非表示化
   - 行高・セル書式調整

#### 2.1.2 出力ファイル仕様
- **ファイル名**: `【{自治体名}】育児サークル等修正用データ（{月}月分）.xlsx`
- **シート構成**:
  - `circle_info`: 編集用シート（表示）
  - `original`: 差分検出用シート（非表示）
- **条件付き書式**: 変更箇所のハイライト
- **データ範囲**: 4行目から開始（1-3行目はヘッダー）

### 2.2 インポートデータ作成機能

#### 2.2.1 ファイル読み込み
- **Excel検証** (`validate_import_excel_file`)
  - シート数チェック（2シート必須）
  - `original`シート存在確認
  - スキップ行数設定（0-10行、デフォルト2行）
  - 削除行検出（B列スラッグ比較）

#### 2.2.2 データ検証（16項目）

**1. 修正・削除新規ステータス** (`validate_modification_status`)
- **入力データ**: メインデータ、差分検出用データ
- **許可値検証**: `['修正', '新規追加', '掲載順', '削除']`以外の値をエラー検出
- **修正時の検証**:
  - スラッグで差分検出用データから同一行を検索
  - 除外列: `['修正・削除新規', 'ｱｶｳﾝﾄ発行有無', 'ｱｶｳﾝﾄ発行年月', 'アカウント発行の登録用メールアドレス']`
  - `normalize_value()`で値を正規化して比較
  - 実際の変更がない場合はエラー（アカウント関連のみの変更は除外）
- **新規追加時の検証**:
  - スラッグ列が空欄でない場合はエラー
  - HP掲載可列が「○」でない場合はエラー
- **掲載順時の検証**:
  - スラッグで差分検出用データから同一行を検索
  - 順番列の値を比較し、変更がない場合はエラー
- **エラー出力**: 列位置情報付きエラーメッセージ（`get_column_position_text()`使用）

**2. 空欄ステータス** (`validate_empty_status`)
- **入力データ**: メインデータ、差分検出用データ
- **検証対象**: 修正・削除新規列が空欄（`normalize_value() == ''`）の行
- **変更検出ロジック**:
  - スラッグで差分検出用データから同一行を検索
  - 除外列: `['修正・削除新規', 'ｱｶｳﾝﾄ発行有無', 'ｱｶｳﾝﾄ発行年月', 'アカウント発行の登録用メールアドレス']`
  - `normalize_value()`で値を正規化して比較
  - 変更された列を検出し、列位置情報付きでエラー表示
- **エラー条件**: 修正・削除新規列が空欄なのに実際にデータが変更されている場合

**3. 機種依存文字** (`validate_machine_dependent_characters`)
- **入力データ**: メインデータ
- **検証対象列**: `['サークル名', '概要', '活動場所', '申込方法', '会費', '活動日_備考', '団体名（ふりがな）', '小学校区', '小学校区（ふりがな）', '代表者名', '代表者名（ふりがな）', '代表者住所', '記入者', '場所']`
- **検出文字**: `['①', '②', '③', '④', '⑤', '⑥', '⑦', '⑧', '⑨', '⑩', '㍉', '㌔', '㌘', '㌧', '㌃', '㌍', '㌦', '㌢', '㌘', '㌧']`
- **検証処理**: 
  - `normalize_value()`で値を正規化
  - 空欄でない場合のみチェック
  - 機種依存文字が含まれている場合はエラー
- **エラー出力**: 「{列名}列に機種依存文字が含まれています」+ 列位置情報

**4. セル内改行** (`validate_cell_line_breaks`)
- **入力データ**: メインデータ
- **検証対象列**: `['サークル名', '活動種別', '活動場所', '申込方法', 'Eメールアドレス', '会費', 'Webサイト', '活動日_備考', '団体名（ふりがな）', '幼稚園・保育園チェック', '小学校区', '小学校区（ふりがな）', '代表者名', '代表者名（ふりがな）', '代表者住所', '記入者', '場所']`
- **検出文字**: `\n`, `\r`
- **検証処理**: 
  - `normalize_value()`で値を正規化
  - 改行文字が含まれている場合はエラー
- **エラー出力**: 「{列名}列にセル内改行が含まれています」+ 列位置情報

**5. 変更禁止列** (`validate_prohibited_changes`)
- 対象列: `['スラッグ', 'ステータス', '参加者の条件(妊娠後半)', '参加者の条件(1歳後半)', '参加者の条件(2歳後半)', '申込方法備考']`

**6. 連続した空白** (`validate_consecutive_spaces`)
- 検出パターン: 3つ以上の連続空白

**7. 半角英数** (`validate_alphanumeric`)
- **入力データ**: メインデータ
- **検証対象列**: `['申込先電話番号', '代表者郵便番号', '代表者電話番号', '代表者FAX', '代表者携帯番号', '順番']`（Webサイト列は除外）
- **許可文字**: `[a-zA-Z0-9\\-‐–—−\\.\\/:]*`（半角英数字、各種ハイフン、ピリオド、スラッシュ、コロン）
- **検証処理**: 
  - `normalize_value()`で値を正規化
  - 空欄でない場合のみチェック
  - 許可文字以外が含まれている場合はエラー
- **エラー出力**: 「{列名}列に半角英数字以外の文字が含まれています」+ 列位置情報

**8. メールアドレス** (`validate_email_addresses`)
- 対象列: `['メールアドレス', 'アカウント発行の登録用メールアドレス']`
- 正規表現: `^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$`

**9. 必須項目** (`validate_required_fields`)
- 対象列: `['サークル名', '概要', '活動場所']`

**10. マルバツ** (`validate_circle_or_cross`)
- 対象列: 参加者の条件、要会費、各種掲載可フラグ
- 許可値: `['○', '']`

**11. 活動場所** (`validate_facility_location`)
- **入力データ**: メインデータ、施設情報データ
- **検証処理**:
  - 施設情報データが存在し、「施設名」列がある場合のみ実行
  - 施設情報データから施設名のセットを作成: `set(facility_data['施設名'].astype(str).str.strip())`
  - メインデータの「活動場所」列の値を`normalize_value()`で正規化
  - 空欄でない場合のみチェック
- **エラー条件**: 活動場所の値が施設情報データの施設名に存在しない場合
- **エラー出力**: 「活動場所が施設情報に存在しません」+ 列位置情報

**12. ステータス** (`validate_status_column`)
- 許可値: `['publish', 'private']`

**13. webサイトURL** (`validate_website_urls`)
- **入力データ**: メインデータ
- **検証対象**: 「Webサイト」列
- **前処理**:
  - `normalize_value()`で値を正規化
  - @で始まる場合は@を除去
  - 空欄でない場合のみチェック
- **非同期処理**:
  - `aiohttp.ClientSession()`を使用
  - `validate.py`の`is_url_alive()`関数を呼び出し
  - URL数が2以上の場合は進捗バー表示
  - 各URLの検証結果を収集
- **エラー出力**: 列位置情報付きエラーメッセージ
- **エラー処理**: 検証失敗時は「URL検証エラー」として処理

**14. アカウント発行年月** (`validate_account_issue_date`)
- **入力データ**: メインデータ
- **検証対象列**: `ｱｶｳﾝﾄ発行年月`
- **和暦→西暦変換**:
  - 形式: `R{年},{月}` または `R{年}.{月}`
  - 変換ロジック: 令和年 + 2018 = 西暦年
  - 月の範囲チェック: 1-12
  - 令和年の妥当性チェック: 1-50年
- **検証処理**: 
  - `normalize_value()`で値を正規化
  - 空欄でない場合のみチェック
  - `convert_wareki_to_seireki_for_validation()`で変換可能性をチェック
- **エラー出力**: 「ｱｶｳﾝﾄ発行年月列に変換できない値が入力されています」+ 列位置情報

**15. 曜日** (`validate_weekdays`)
- 許可値: `['月', '火', '水', '木', '金', '土', '日']`
- カンマ区切り形式

**16. 時間** (`validate_business_hours`)
- **入力データ**: メインデータ
- **検証対象列**: `活動日_開始時間`, `活動日_終了時間`
- **時間形式チェック**:
  - 許可形式: `HH:MM` または `HH:MM:SS`
  - 時間範囲: 0-23時、0-59分、0-59秒
  - `is_valid_time_format()`で形式検証
- **論理チェック**:
  - 開始時間と終了時間の両方が有効な場合のみ実行
  - `time_to_minutes()`で分単位に変換して比較
  - 開始時間 >= 終了時間の場合はエラー
- **エラー出力**: 
  - 形式エラー: 「開始時間の形式が違います」「終了時間の形式が違います」
  - 論理エラー: 「開始時間と終了時間が同じまたは逆転しています」

#### 2.2.3 データ整形 (`format_for_import`)
- **入力データ**: メインデータ、差分検出用データ
- **バイナリ列変換**:
  - 対象列: `['参加者の条件(妊娠)', '参加者の条件(0歳)', ..., '要会費', '冊子掲載可', 'HP掲載可', 'オープンデータ掲載可']`
  - 変換ロジック: `normalize_value()`で正規化後、○→1, 空欄→0
  - 特殊処理: `参加者の条件(妊娠後半)`に`参加者の条件(妊娠)`の値をコピー
- **入力禁止列の処理**:
  - 対象列: `['申込方法備考', '活動日_営業時間ラベル', '活動日_営業曜日ラベル']`
  - 処理: 空文字で埋める
  - 特殊処理: `参加者の条件(出産)`は一律「0」で埋める
- **ステータス優先順位**:
  1. 修正・削除新規列が「削除」 → ステータス列を「private」
  2. 修正・削除新規列が「削除」でない かつ 空欄 → ステータス列を「publish」
  3. HP掲載可列が1 → ステータス列を「publish」
  4. HP掲載可列が0 → ステータス列を「private」
- **順番の修正**:
  - 新しい順番を1から連番で設定
  - 差分検出用データとの順番比較
  - 実際に変更があった行のみ「掲載順」ステータスを設定

#### 2.2.4 インポートファイル生成 (`create_import_files`)
- **入力データ**: 整形済みデータ、差分検出用データ、ユーザーデータ、自治体名、整形前メインデータ
- **ヘッダーマッピング**: CSVヘッダーをテンプレートヘッダーに変換
  - 例: `参加者の条件(妊娠)` → `対象年齢(妊娠前半)`
- **育児サークル新規追加CSV**:
  - 抽出条件: `修正・削除新規 == '新規追加'`
  - ヘッダー変換後、テンプレート形式で出力
- **育児サークル修正CSV**:
  - 抽出条件: `修正・削除新規 in ['修正', '削除', '掲載順']`
  - アカウント関連のみの変更は除外（`is_only_account_related_change()`で判定）
  - 修正対象列の検出（`detect_modified_columns()`で整形前データから差分検出）
  - 表示用データ（修正対象列含む）とダウンロード用データ（修正対象列除外）を分離
- **ユーザーインポートデータ**:
  - `create_user_import_data()`で新規追加と修正を統合処理
  - 新規追加: アカウント発行有無=○ かつ メールアドレス記載 かつ （新規追加ステータス または アカウント発行有無差分）
  - 修正: アカウント発行の登録用メールアドレス列の差分検出
  - メールアドレス重複チェック、既存ユーザーとの差分チェック

## 3. エラーハンドリング

### 3.1 エラーメッセージ形式
- **列位置表示**: `（A列）`, `（BC列）` など
- **具体的内容**: エラーの詳細説明
- **対処方法**: 修正すべき内容の明示

### 3.2 セッション管理
- **ファイル変更検出**: 
  - `check_file_changed()`でMD5ハッシュ比較
  - ファイル内容から`hashlib.md5()`でハッシュ生成
  - 前回のハッシュと比較し、変更時のみセッション状態リセット
- **状態追跡**: 
  - `st.session_state`で状態管理
  - 主要状態: `validation_completed`, `validated_data`, `import_data_created`, `import_files`, `formatted_data`
- **ログ機能**: 
  - `log_session_state_change()`でセッション変化を記録
  - タイムスタンプ、アクション、詳細情報、セッション状態を記録
  - 最大50件のログを保持

## 4. UI/UX仕様

### 4.1 レイアウト
- **タブ式**: データ修正用エクセル作成 / インポートデータ作成
- **サイドバー**: 使い方説明、デバッグモード、AIチャット
- **プログレスバー**: URL検証時の進捗表示

### 4.2 検証項目選択
- **3列レイアウト**: 効率的な項目選択
- **全選択/全解除**: 一括操作機能
- **ヘルプテキスト**: 各項目の詳細説明

### 4.3 結果表示
- **エラー詳細**: 展開可能なセクション
- **データプレビュー**: 処理結果の確認
- **ダウンロード**: 個別ファイル取得

## 5. 技術的詳細

### 5.1 データ処理
- **欠損値処理**: 
  - `normalize_value()`関数で統一的処理
  - `pd.isna()`で欠損値判定
  - `['nan', 'None', '<NA>']`文字列も空文字列に変換
  - `str().strip()`で前後の空白除去
- **エンコーディング**: 
  - `detect_encoding()`でchardetによる自動検出
  - 検出順序: UTF-8 → Shift-JIS → CP932 → EUC-JP
  - 各エンコーディングでの読み込み試行
  - 成功したエンコーディングを返却
- **Excel操作**: 
  - `openpyxl`による詳細な書式制御
  - `copy_cell_format()`でセル書式のコピー
  - `add_borders()`で枠線追加
  - `setup_conditional_formatting()`で条件付き書式設定

### 5.2 非同期処理
- **URL検証**: 
  - `aiohttp.ClientSession()`による並列処理
  - `validate.py`の`is_url_alive()`関数を非同期実行
  - ドメイン重複時の2秒待機処理
  - 最大4ドメインまでの履歴管理
- **進捗表示**: 
  - URL数が2以上の場合に`st.progress()`表示
  - `st.empty()`を使用したリアルタイム更新
  - 検証完了後にプログレスバーをクリア

### 5.3 セキュリティ
- **秘密鍵管理**: Streamlit Secretsによる安全な管理
- **入力検証**: 包括的なデータ検証
- **エラー処理**: 例外の適切なハンドリング

## 6. 運用・保守

### 6.1 デプロイ
- **Streamlit Cloud**: 自動デプロイ対応
- **環境変数**: 設定の外部化
- **依存関係**: requirements.txtによる管理

### 6.2 監視・デバッグ
- **デバッグモード**: 詳細情報の表示
- **ログ機能**: セッション状態の追跡
- **エラー追跡**: 包括的なエラー情報

### 6.3 制限事項
- **ファイルサイズ**: 200MB上限
- **セッション**: ファイル変更時の自動リセット
- **同時ユーザー**: Streamlit Cloudの制限に依存

## 7. よくある質問と対処法

### 7.1 エラー関連
- **ModuleNotFoundError**: 依存関係のインストール不足
- **エンコーディングエラー**: 文字コード検出失敗
- **メモリエラー**: ファイルサイズ制限超過

### 7.2 データ関連
- **検証エラー**: 各検証項目の詳細確認
- **ファイル形式**: 対応形式の確認
- **データ整合性**: 元データとの比較

### 7.3 操作関連
- **ファイルアップロード**: 対応形式とサイズ制限
- **結果ダウンロード**: ブラウザ設定の確認
- **セッション管理**: 状態リセットのタイミング

## 8. バージョン情報
- **現在バージョン**: v2.4 (2025/07/16)
- **主要機能**: 16項目検証、AIチャット、セッション管理
- **対応形式**: CSV, Excel,多言語エンコーディング

## 9. 関数リファレンス

### 9.1 データ検証関数
- `validate_csv_file()`: CSVファイルの基本検証
- `validate_facility_csv_file()`: 施設情報CSV検証
- `validate_import_excel_file()`: インポート用Excel検証
- `perform_data_validation()`: 包括的データ検証

### 9.2 データ処理関数
- `normalize_value()`: 欠損値統一処理
- `format_for_import()`: インポート用データ整形
- `create_import_files()`: インポートファイル生成

### 9.3 UI関数
- `show_modification_excel_page()`: 修正用Excel作成ページ
- `show_import_data_page()`: インポートデータ作成ページ
- `show_sidebar_chat()`: AIチャット機能

### 9.4 ユーティリティ関数
- `get_excel_column_name()`: 列インデックス→エクセル形式変換
- `get_column_position_text()`: 列位置テキスト生成
- `detect_encoding()`: エンコーディング検出 